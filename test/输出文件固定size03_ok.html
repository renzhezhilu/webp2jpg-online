<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

</head>

<body>
    <input id="files" type="file" multiple />
    <h4 id="t1"></h4>
    <img id="img01" src="" alt="">
    <canvas id="can"></canvas>
    <h4 id="t2"></h4>
    <img id="img02" src="" alt="">
    <script>
        let input = document.getElementById("files")

        let img01 = document.getElementById("img01")
        let img02 = document.getElementById("img02")
        input.addEventListener('change', function() {
            console.log(this.files[0]);
            let files = this.files
            let img = new Image()
           
            img.src = URL.createObjectURL(this.files[0])
            img.onload = async function() {
                console.log(this);
                let jg = await funMaxSize({
                    defWidth:this.width,
                    defHeight:this.height,
                    setWidth:400,
                    setHeight:null,
                    imageData:this,
                    setSize:88
                })
                // let b= new Blob(this)
                // URL.createObjectURL(b)
                console.log('ğŸ˜Š ç»“æœï¼š',jg,JSON.stringify(this),);
                
            }
        }, false)




        function funMaxSize({
            defWidth,
            defHeight,
            setWidth,
            setHeight,
            imageData,
            setSize=100 //kb
        }) {
            return new Promise((res, rej) => {
                let arg = arguments[0]
                let count = 0
                let _canvas = document.getElementById("can")
                //å¤„ç†ç¼©æ”¾
                let w = arg.setWidth || arg.defWidth
                let h = arg.setHeight || (arg.setWidth/arg.defWidth) * arg.defHeight
                _canvas.setAttribute("width", w)
                _canvas.setAttribute("height", h)
                _canvas.getContext("2d").drawImage(arg.imageData, 0, 0, w, h)
                //è½¬æ ¼å¼
                console.log(_canvas);

                //è¾“å‡º100%è´¨é‡
                _canvas.toBlob(function(blob) {
                    console.log(blob, 'å®Œæˆ0.81');
                    // let size = 1024 * 100 //é¢„è®¾å€¼
                    let size = arg.setSize * 1000 //é¢„è®¾å€¼
                    
                    size = size - 4000 //é»˜è®¤ç°‡
                    let skip = 0.01 //å˜åŒ–å¹…åº¦
                    let maxSize = blob.size //1å‹ç¼©


                    //å…ˆé¢„åˆ¤å›¾ç‰‡å‹ç¼©åçš„å¤§å°å†å¾®è°ƒ
                    let yu = size > maxSize ? 0.81 * 0.81 : 0.81
                    let startQu = size / maxSize * yu

                    if (startQu >= 1) startQu = 0.99
                    if (startQu <= 0) startQu = 0.01
                    setSizeFun(size, startQu.toFixed(2) - 0)

                    function setSizeFun(setSize, qu) {
                        _canvas.toBlob(function(blob22) {
                            console.log('count:', count++);

                            // let isLess =  blob22.size < setSize
                            console.log(blob22, qu, 'ç»§ç»­');
                            img02.src = URL.createObjectURL(blob22)
                            let bSize = blob22.size
                            //ç¬¦åˆæ¡ä»¶åŒºé—´
                            if (bSize > setSize * 0.9 && bSize < setSize) {
                                console.log(blob22, URL.createObjectURL(blob22), qu, 'å®Œæˆâœ…âœ…âœ…');
                                res(URL.createObjectURL(blob22))
                                return
                            }
                            //åŸå›¾å¤ªå°ï¼Œ
                            if (qu >= 0.95 && bSize < setSize) {
                                console.warn(blob22, qu, URL.createObjectURL(blob22), 'æœ€å¤§è¾“å‡ºâœ…');
                                res(URL.createObjectURL(blob22))
                                return
                            }
                            //å‹ç¼©ä¸åˆ°åˆ¶å®šçš„å¤§å°
                            if (qu < 0.0001 && bSize > setSize) {
                                console.error(blob22, qu, URL.createObjectURL(blob22), 'æ²¡æœ‰ç¬¦åˆçš„ğŸ™…');
                                rej(URL.createObjectURL(blob22))

                                return
                            }
                            if (qu < 0.0001 && bSize < setSize) {
                                console.warn(blob22, qu, URL.createObjectURL(blob22), 'æœ€å°è¾“å‡ºâœ…');
                                res(URL.createObjectURL(blob22))
                                return
                            }
                            //å¾®è°ƒ
                            if (bSize < setSize) {
                                qu = qu + skip
                            } else {
                                qu = qu - skip
                            }
                            setSizeFun(setSize, qu.toFixed(2) - 0)

                        }, `image/webp`, qu)
                    }

                }, `image/webp`, 0.81)
            })
        }
    </script>
</body>

</html>